<head>
    <title>YAS-Sun calculator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Lucida Sans', sans-serif;
            padding: 1rem;
        }

        .header {
            background-color: skyblue;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .header h2 {
            font-size: 1.25rem;
            word-wrap: break-word;
        }

        .header a {
            color: inherit;
            text-decoration: none;
        }

        .section-title {
            color: blue;
            font-size: 1.1rem;
            font-weight: 800;
            border-bottom: dashed black;
            padding: 0.5rem 0;
            margin: 1rem 0;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        table {
            width: 70%;
            margin-bottom: 1rem;
            border-collapse: collapse;
        }

        th,td {
            background-color: azure;
            border: 1px solid cornflowerblue;
            padding: 0.5rem;
            font-size: 0.9rem;
        }

        input[type="number"],
        input[type="date"],
        input[type="time"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid gray;
            border-radius: 4px;
        }

        input[type="checkbox"],
        input[type="radio"] {
            width: 1.2rem;
            height: 1.2rem;
            vertical-align: middle;
        }

        button {
            background-color: skyblue;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 0.5rem;
        }

        textarea {
            width: 100%;
            font-size: large;
            background-color: lightgray;
            color: blue;
            padding: 0.5rem;
            border-radius: 4px;
        }

        canvas {
            max-width: 100%;
            height: auto;
        }

        /* Responsive layout */
        @media screen and (min-width: 768px) {
            button {
                width: auto;
            }
        }
    </style>
</head>
<body>
    <h2 style="background-color: skyblue"><a href="https://yingyan797.github.io/no-backend">Home page</a> | Y-Astronomy Sun calculator & graphics| 
        <button style="width: auto; font-size: large; color: blueviolet;" onclick="vis_switch()"><b id="mode">3D Visualization page >></b></button></h2>
    <form action="javascript: ;"  onsubmit="process_form(this)"><br><div id="calculator" style="display: block;">
        <i style="font-size: larger; background-color: lightgoldenrodyellow;">[ Sun calculator ] -- Select one or more of the functions -- </i>
        <p class="section-title">1. Sunrise/Sunset time and direction, Daylight hours <input type="checkbox" oninput="hide_show('func_1')"></p>
        <div style="display: none;" id="func_1">
            <table><tr>
                <th>Longitude</th><th>Latitude</th><th>Time zone</th><th>Date</th>
            </tr><tr">
                <td><input type="number" id="lon_1" min="-180" max="180" step="0.01" value="120"></td> 
                <td><input type="number" id="lat_1" min="-90" max="90" step="0.01" value="35"></td> 
                <td><input type="number" id="tz_1" min="-12" max="12" value="8"></td> 
                <td><input type="date" id="date_1" value="2024-03-21"></td><td><button type="submit" value="calc_1">Calculate</button></td>
            </tr></table> -- Results -- 
            <table style="display: none;" id="res_1">
                <tr><th>Sunrise</th><th>Direction</th><th>Sunset</th><th>Direction</th>
                    <th>Daylight</th><th style="color: black;">Sun trajectory of the day </th></tr>
                <tr style="color: black;"><td id="_1_sr"></td><td id="_1_rd"></td><td id="_1_ss"></td><td id="_1_sd"></td><td id="_1_dl"></td>
                    <td><input type="submit" id="plot_1" value="Draw trajectory >>"></td></tr>
            </table></div> 
        <p class="section-title">2. Sun height and direction at any time of the day <input type="checkbox" oninput="hide_show('func_2')"></p>
        <div style="display: none;" id="func_2">
            <table><tr>
                <th>Longitude</th><th>Latitude</th><th>Time zone</th><th>Date</th><th>Time</th>
            </tr><tr">
                <td><input type="number" id="lon_2" min="-180" max="180" step="0.01" value="120"></td> 
                <td><input type="number" id="lat_2" min="-90" max="90" step="0.01" value="35"></td> 
                <td><input type="number" id="tz_2" min="-12" max="12" value="8"></td> 
                <td><input type="date" id="date_2" value="2024-03-21"></td>
                <td><input type="time" id="time_2" value="17:05"></td>
                <td><button type="submit" value="calc_2">Calculate</button></td>
            </tr></table> <div id="res_2" style="display: none; color: cornflowerblue;">
                Sun height <br> <textarea readonly id="_2_sh" rows="1" style="width: 80%;"></textarea> <br> Sun direction <br> <textarea readonly id="_2_sd" rows="1" style="width: 80%;"></textarea> <br>
                Sun trajectory of the day: <button type="submit" id="plot_2" value="draw">Draw >></button>
        </div></div> 
        <p class="section-title">3. Time(s) of the day when Sun reaches a certain height/direction <input type="checkbox" oninput="hide_show('func_3')"></p>
        <div style="display: none;" id="func_3">
            <table style="width: 85%;"><tr>
                <th>Longitude</th><th>Latitude</th><th>Time zone</th><th>Date</th>
                <th><input type="radio" name="angmode_3" oninput="input_ang('ht',3)"><label for="angmode_3" id="ht_lab_3">Sun height</label>; 
                    <input type="radio" name="angmode_3"oninput="input_ang('drn',3)"><label for="angmode_3" id="drn_lab_3">Direction</label></th>
            </tr><tr">
                <td><input type="number" id="lon_3" min="-180" max="180" step="0.01" value="120"></td> 
                <td><input type="number" id="lat_3" min="-90" max="90" step="0.01" value="35"></td> 
                <td><input type="number" id="tz_3" min="-12" max="12" value="8"></td> 
                <td><input type="date" id="date_3" value="2024-03-21"></td>
                <td><input type="number" id="ang_3" value="30" min="-90" max="360" step="0.01" style="width: auto;"> (degree)</td>
                <td><button type="submit" id="calc_3" value="calc_3" disabled>Calculate</button></td>
            </tr></table><div id="res_3" style="display: none;"></div>
        </div>
        <p class="section-title">4. Date of the year when Sun appears in a certain position at a given time <input type="checkbox" oninput="hide_show('func_4')"></p>
        <div style="display: none;" id="func_4">
            <table style="width: 85%;"><tr>
                <th>Longitude</th><th>Latitude</th><th>Time zone</th><th>Time</th>
                <th><input type="radio" name="angmode_4" oninput="input_ang('ht',4)"><label for="angmode_4" id="ht_lab_4">Sun height</label>; 
                    <input type="radio" name="angmode_4" oninput="input_ang('drn',4)"><label for="angmode_4" id="drn_lab_4">Direction</label></th>
            </tr><tr">
                <td><input type="number" id="lon_4" min="-180" max="180" step="0.01" value="120"></td> 
                <td><input type="number" id="lat_4" min="-90" max="90" step="0.01" value="35"></td> 
                <td><input type="number" id="tz_4" min="-12" max="12" value="8"></td> 
                <td><input type="time" id="time_4" value="17:05"></td>
                <td><input type="number" id="ang_4" value="30" min="-90" max="360" step="0.01" style="width: auto"> (degree)</td>
            </tr></table> <i style="color: gray; font-size: 15;">Optional condition: narrow down the date range (for Daylight daving time, etc.) 
            <input type="checkbox" onclick="hide_show('opt_4')"></i> <span id="opt_4" style="display: none;"> 
            <b>Date from:</b> <input type="dfrom_4" value="2024-04-01" width="auto">;
            <b>Date to: </b><input type="dfrom_4" value="2024-10-15" width="auto"> <i style="font-size: small;">(make sure GMT time zone is the same over this period)</i></span> 
            <button type="submit" id="calc_4" value="calc_4" disabled style="width: auto;">Calculate >></button>
        
        </div>
        <br><i style="background-color: lightgoldenrodyellow;">Other calculators</i><br>
        <p class="section-title">1. The distance between any two locations on Earth <input type="checkbox" oninput="hide_show('func_a1')"></p>
        <div style="display: none;" id="func_a1"><table>
            <tr><td>Locations</td><th>Longitude</th><th>Latitude</th></tr>
            <tr><th>1</th><td><input type="number" id="lon_a1_1" min="-180" max="180" step="0.01" value="120"></td>
                <td><input type="number" id="lat_a1_1" min="-90" max="90" step="0.01" value="35"></td></tr>
            <tr><th>2</th><td><input type="number" id="lon_a1_2" min="-180" max="180" step="0.01" value="25"></td> 
                <td><input type="number" id="lat_a1_2" min="-90" max="90" step="0.01" value="45"></td></tr>
        </table>Earth radius (km): <input type="number" id="radius_a1" value="6371" min="0" max="9e10"><br>
        Distance: <button type="submit" value="calc_a1" style="width: auto;">Calculate >></button><textarea readonly id="res_a1"></textarea>
        </div><p class="section-title">2. The distance to an object in the sky observed at a certain angle <input type="checkbox" oninput="hide_show('func_a2')"></p>
        <p class="section-title">3. Maximum observable distance to horizon standing at a given altitude<input type="checkbox" oninput="hide_show('func_a2')"></p>
    </div><div id="visual3d" style="display: none;"> <h3 style="color: cornflowerblue;">3D Graphical display of the related phenomenon</h3>
            <textarea readonly id="vis_desc"></textarea><br><canvas></canvas></div> 
    </form>
    <script>
        function deg_to_rad(deg) {
            return deg / 180 * Math.PI;
        } function rad_to_deg(rad) {
            return 180 * rad / Math.PI
        } function sin_to_cos(sin) {
            if (sin >= 1 || sin <= -1)
                return 0;
            return Math.sqrt(1-sin*sin)
        } function dot(v1, v2) {
            return v1.map((x, i) => v1[i] * v2[i]).reduce((p1, p2) => p1 + p2);
        } function vec_angle(v1, v2) {
            const cos = dot(v1,v2) / Math.sqrt(dot(v1, v1) * dot(v2, v2));
            if (cos >= 1) {
                return 0;
            } else if (cos <= -1) {
                return Math.PI
            }
            return Math.acos(cos);
        } function vec_debase(v1, v2) {
            const l2 = Math.sqrt(dot(v2, v2))
            const dl = dot(v1, v2) / l2;
            return v2.map((x,i) => v1[i] - x/l2*dl);
        }

        function triangular(lat, dlon) {
            return [Math.cos(lat),Math.cos(dlon+Math.PI/2),Math.sin(lat),Math.sin(dlon+Math.PI/2)]
        } function sun_vectors(lat, noon_shift) {
            let dlon = 0;
            if (noon_shift.length == 1) {
                dlon = noon_shift[0];
            } else {
                dlon = (noon_shift[1] - noon_shift[0])/86400*2*Math.PI
            }
            // alert(dlon);
            const vs = triangular(lat, dlon);
            return [[vs[0]*vs[1], vs[0]*vs[3], vs[2]], 
                    [-vs[3], vs[1], 0],
                    [-vs[2]*vs[1], -vs[2]*vs[3], vs[0]]]
        } function sun_geom(sinlat0, lat, noon_shift) {
            const vecs = sun_vectors(lat, noon_shift);
            const sun = [0, sin_to_cos(sinlat0), sinlat0];
            const ht = Math.PI/2 - vec_angle(sun, vecs[0]);
            const ort = vec_debase(sun, vecs[0]);
            let drn = vec_angle(ort, vecs[2]);
            if (dot(ort, vecs[1]) < 0) {
                drn = 2*Math.PI - drn;
            }
            return [drn, ht]
        } function sun_ht(sinlat0, lat, noon_shift) {
            const sun = [0, sin_to_cos(sinlat0), sinlat0];
            const loc = sun_vectors(lat, noon_shift)[0];
            return Math.PI/2 - vec_angle(sun, loc);
        } function sun_drn(sinlat0, lat, noon_shift) {
            const vecs = sun_vectors(lat, noon_shift);
            const sun = [0, sin_to_cos(sinlat0), sinlat0];
            const ort = vec_debase(sun, vecs[0]);
            let drn = vec_angle(ort, vecs[2]);
            if (dot(ort, vecs[1]) < 0) {
                drn = 2*Math.PI - drn;
            }
            return drn;
        }
        function direction_class(ang) {
            const rg = 10;
            if (ang < rg || ang > 360-rg)
                return "North";
            if (ang >= rg && ang <= 90-rg)
                return "Northeast";
            if (ang > 90-rg && ang < 90+rg)
                return "East";
            if (ang >= 90+rg && ang <= 180-rg)
                return "Southeast";
            if (ang > 180-rg && ang < 180+rg)
                return "South";
            if (ang >= 180+rg && ang <= 270-rg)
                return "Southwest";
            if (ang > 270-rg && ang < 270+rg)
                return "West";
            if (ang >= 270+rg && ang <= 360-rg)
                return "Northwest";
        }

        function time_convert(seconds) {
            let secs = seconds;
            let d = 0;
            while (seconds < 0) {
                secs += 86400;
                d = -1;
            }
            while (seconds > 86400) {
                secs -= 86400;
                d += 1;
            }
            const h = parseInt(secs / 3600);
            const m = parseInt((secs - 3600*h) / 60);
            const s = secs - 3600*h - 60*m;
            return [h, m, s, d]
        } function time_display(secs) {
            let tcv = time_convert(secs);
            for (i = 0; i < tcv.length; i++) {
                if (tcv[i] < 10) {
                    tcv[i] = "0"+String(tcv[i]);
                }
            }
            let res = tcv[0]+":"+tcv[1]+":"+tcv[2];
            if (tcv[3] > 0) {
                res += " ["+tcv[3]+"day(s) after]";
            } else if (tcv[3] < 0) {
                res += " ["+(-tcv[3])+"day(s) before]";
            }
            return res;
        }
        function sun_direct_lat_sin(date) {
            const y = date.getFullYear();
            const sprg_eqnx_secs = (date - new Date(y, 2, 21))/1000
            const ydays = (y % 400 === 0 || (y % 100 !== 0 && y % 4 === 0)) ? 366 : 365
            const phase = 2 * Math.PI * sprg_eqnx_secs / (86400 * ydays);
            let res = Math.sin(phase) * Math.sin(deg_to_rad(23.5));
            if (res > 1) {
                res = 1;
            }
            return res;
        } function day_length(pss, lat) {
            const sbs = Math.tan(lat) * pss / Math.sqrt(1-pss*pss);
            let day_time_balance = 90;
            if (sbs <= -1) {
                day_time_balance = -90;
            } else if (sbs < 1) {
                day_time_balance = rad_to_deg(Math.asin(sbs));
            }
            return 86400 * (day_time_balance * 2 + 180) / 360
        } function noon_seconds(tz, lon) {
            return 43200 + 3600*(15 * tz - lon)/15
        }

        // Form processing main functions
        function hide_show(sec_id) {
            if (document.getElementById(sec_id).style.display == "none") {
                document.getElementById(sec_id).style.display = "block";
            } else {
                document.getElementById(sec_id).style.display = "none";
            }
        } function vis_switch() {
            hide_show("calculator");
            hide_show("visual3d");
            if (document.getElementById("mode").innerText === "3D Visualization page >>") {
                document.getElementById("mode").innerText = "<< Back to sun calculator";
            } else {
                document.getElementById("mode").innerText = "3D Visualization page >>";
            }
        } function input_ang(aname, num) {
            const field = "ang_"+num; 
            document.getElementById("calc_"+num).disabled = false;
            switch (aname) {
                case "ht":
                    document.getElementById(field).min = -90;
                    document.getElementById(field).max = 90;
                    document.getElementById("ht_lab_"+num).style.color = "blueviolet";
                    document.getElementById("ht_lab_"+num).style.fontSize = "large";
                    document.getElementById("drn_lab_"+num).style.color = "gray";
                    document.getElementById("drn_lab_"+num).style.fontSize = "small";
                    break;
                case "drn":
                    document.getElementById(field).min = 0;
                    document.getElementById(field).max = 360;
                    document.getElementById("ht_lab_"+num).style.color = "gray";
                    document.getElementById("ht_lab_"+num).style.fontSize = "small";
                    document.getElementById("drn_lab_"+num).style.color = "blueviolet";
                    document.getElementById("drn_lab_"+num).style.fontSize = "large";
                    break;
            }
        }

        function sunrise_set(num) {
            const lon = document.getElementById("lon_"+num).value
            const lat = deg_to_rad(document.getElementById("lat_"+num).value);
            const tz = document.getElementById("tz_"+num).value;
            const date = new Date(document.getElementById("date_"+num).value)
            const pss = sun_direct_lat_sin(date);
            const dl = day_length(pss, lat);
            const hdl = dl/2;
            const noon = noon_seconds(tz, lon);
            const nsfts = [-hdl/86400*2*Math.PI, hdl/86400*2*Math.PI];
            const drn = nsfts.map((x,i) => Math.round(100*rad_to_deg(sun_geom(pss, lat, [x])[0]))/100);
            const dclass = drn.map((x,i) => direction_class(x));
            document.getElementById("res_"+num).style.display = "block";
            document.getElementById("_"+num+"_sr").innerHTML = time_display(Math.round(noon - hdl));
            document.getElementById("_"+num+"_rd").innerHTML = drn[0]+" <span style='font-size: small'>"+dclass[0]+"</span>"
            document.getElementById("_"+num+"_ss").innerHTML = time_display(Math.round(noon + hdl));
            document.getElementById("_"+num+"_sd").innerHTML = drn[1]+" <span style='font-size: small'>"+dclass[1]+"</span>"
            document.getElementById("_"+num+"_dl").innerHTML = time_display(Math.round(dl));
        }

        function sun_position(num) {
            const lon = document.getElementById("lon_"+num).value
            const lat = deg_to_rad(document.getElementById("lat_"+num).value);
            const tz = document.getElementById("tz_"+num).value;
            const date0 = new Date(document.getElementById("date_"+num).value);
            const date = new Date(document.getElementById("date_"+num).value+"T"+document.getElementById("time_"+num).value+":00")
            const noon = noon_seconds(tz, lon);
            const sinlat0 = sun_direct_lat_sin(date);
            const res = sun_geom(sinlat0, lat, [noon, (date - date0)/1000])
            document.getElementById("res_"+num).style.display = "block";
            const ht = Math.round(100*rad_to_deg(res[1]))/100;
            const drn = Math.round(100*rad_to_deg(res[0]))/100;
            document.getElementById("_"+num+"_sh").value = ht + " degree";
            document.getElementById("_"+num+"_sd").value = drn +" - "+ direction_class(drn);
        }

        function _approach_time(sinlat0, lat, noon, calc, low, high, std) {
            let tl = low;
            let th = high;
            let t = tl;
            while (true) {
                const val = calc(sinlat0, lat, [noon, t])
                const diff = val - std;
                if (diff < 0) {
                    tl = t;
                    if (th - t <= 1) {
                        if (Math.abs(diff) > Math.abs(calc(sinlat0, lat, [noon, th]) - std))
                            t = th;
                        break;
                    }
                    t = (th + t)/2;
                } else {
                    th = t;
                    if (t - tl <= 1) {
                        if (Math.abs(diff) > Math.abs(calc(sinlat0, lat, [noon, tl]) - std))
                            t = tl;
                        break;
                    }
                    t = (t + tl)/2;
                }
            }
            return Math.round(t)
        } function _approach_date() {

        }

        function sun_time_limit(num) {
            const lon = document.getElementById("lon_"+num).value
            const lat = deg_to_rad(document.getElementById("lat_"+num).value);
            const tz = document.getElementById("tz_"+num).value;
            const date0 = new Date(document.getElementById("date_"+num).value);
            const noon = noon_seconds(tz, lon);
            const sinlat0 = sun_direct_lat_sin(date0);
            let degree = document.getElementById("ang_"+num).value;
            const ang = deg_to_rad(degree);
            let res = "";
            let mode = "height";
            document.getElementById("res_"+num).style.display = "block";
            if (document.getElementById("ang_"+num).min == -90) {
                // input angle is sun height, symmetrical monotonic by noon
                const ht_range = [0,-Math.PI].map(ns => sun_ht(sinlat0, lat, [ns])[0]);
                if (ht_range[0] < ang || ht_range[1] > ang) {
                    res = "**Sun height NOT reachable given the date and location -- Max height: "+rad_to_deg(ht_range[0])+"; Min height: "+rad_to_deg(ht_range[1])+" (degree) **";
                } else {
                    const t1 = _approach_time(sinlat0, lat, noon, sun_ht, noon-43200, noon, ang);
                    const t2 = 2*noon - t1;
                    res = "<1> "+time_display(t1)+" | <2> "+time_display(t2);
                }
                degree += " degree"
            } else {
                mode = "direction"; // Whole day monotonic
                const t = _approach_time(sinlat0, lat, noon, sun_drn, noon-43200, noon+43200, ang);
                res = time_display(t);
                degree = degree +" ("+ direction_class(degree)+")"
            }
            document.getElementById("res_"+num).innerHTML = "Times of the day when Sun "+mode+" is "+degree+": <textarea readonly>"+res+"</textarea>";
        }

        function sphere_distance() {
            const lon1 = deg_to_rad(document.getElementById("lon_a1_1").value);
            const lon2 = deg_to_rad(document.getElementById("lon_a1_2").value);
            const lat1 = deg_to_rad(document.getElementById("lat_a1_1").value);
            const lat2 = deg_to_rad(document.getElementById("lat_a1_2").value);
            const rise2 = Math.pow(Math.sin(lat1)-Math.sin(lat2), 2);
            const ra = Math.cos(lat1);
            const rb = Math.cos(lat2);
            const run2 =ra*ra + rb*rb - 2*ra*rb*Math.cos(lon1 - lon2);
            const ang = 2*Math.asin(Math.sqrt(rise2+run2)/2);
            const d = document.getElementById("radius_a1").value*ang
            document.getElementById("res_a1").value = Math.round(100*d)/100 + " km";
        }

        function process_form(fm) {
            try {
                switch (document.activeElement.value) {
                    case "calc_1": sunrise_set(1); break;
                    case "calc_2": sun_position(2); break;
                    case "calc_3": sun_time_limit(3); break
                    case "calc_a1": sphere_distance(); break;
                } 
            } catch(err) {
                alert("[Debug message] "+err);
            }
           
        }
    </script>
</body>